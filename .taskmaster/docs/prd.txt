# AI 운세 마스터 (AI Fortune Master)
# Product Requirements Document (PRD)
# Version: 1.0.0
# Last Updated: 2025-12-20

================================================================================
## 1. EXECUTIVE SUMMARY
================================================================================

### 1.1 Product Vision
AI 운세 마스터는 전통 동양 명리학(사주팔자)과 관상학을 현대 AI 기술과 결합한
모바일 우선 웹 애플리케이션입니다. 사용자가 생년월일시를 입력하면 정확한 만세력
기반 사주 분석을, 얼굴 사진을 업로드하면 AI 기반 관상 분석을 제공합니다.

### 1.2 Target Users
- **Primary**: 40-60대 운세/사주에 관심 있는 한국 사용자
- **Secondary**: 전통 명리학에 대한 신뢰가 높은 보수적 성향의 중장년층
- **Use Cases**: 신년 운세, 자녀/손주 궁합, 건강운, 사업운, 가족 관련 결정

### 1.3 Key Value Propositions
1. **정확성**: lunar-javascript 라이브러리 + 진태양시 보정으로 정밀한 사주 계산
2. **접근성**: 복잡한 명리학을 AI가 쉽게 해석하여 전달
3. **즉시성**: 실시간 스트리밍으로 즉각적인 운세 결과 제공
4. **혁신성**: 관상학 + Computer Vision 결합

================================================================================
## 2. TECHNICAL ARCHITECTURE
================================================================================

### 2.1 Technology Stack

#### Core Framework
| Category        | Technology           | Version    | Purpose                    |
|-----------------|----------------------|------------|----------------------------|
| Framework       | Next.js (App Router) | 16.1.0     | Fullstack React framework  |
| Language        | TypeScript           | 5.x        | Type-safe development      |
| React           | React                | 19.2.3     | UI library                 |
| Styling         | Tailwind CSS         | v4         | Utility-first CSS          |

#### Additional Dependencies (To Install)
| Category        | Package              | Purpose                          |
|-----------------|----------------------|----------------------------------|
| Saju Engine     | lunar-javascript     | 만세력/사주 계산                   |
| AI SDK          | ai                   | Vercel AI SDK (streaming)        |
| AI Provider     | @ai-sdk/openai       | OpenAI integration               |
| State           | zustand              | Lightweight state management     |
| Database        | @supabase/supabase-js| PostgreSQL + Auth                |

#### UI & Design System
| Category        | Package              | Purpose                          |
|-----------------|----------------------|----------------------------------|
| UI Components   | Aceternity UI        | 70+ 프리미엄 React 컴포넌트       |
| Primitives      | @radix-ui/react-*    | 접근성 우선 헤드리스 컴포넌트     |
| Charts          | recharts             | Data visualization               |

#### Animation & Motion
| Category        | Package              | Purpose                          |
|-----------------|----------------------|----------------------------------|
| Animation       | motion (motion.dev)  | 고성능 애니메이션 라이브러리      |
| Transitions     | framer-motion        | React용 선언적 애니메이션         |

#### Icons & Assets
| Category        | Package              | Purpose                          |
|-----------------|----------------------|----------------------------------|
| Icons           | @phosphor-icons/react| 유연한 아이콘 라이브러리 (1,000+) |

#### Media & Detection
| Category        | Package              | Purpose                          |
|-----------------|----------------------|----------------------------------|
| Face Detection  | @mediapipe/face_mesh | 468-point face landmarks         |
| Camera          | react-webcam         | Webcam capture                   |

#### Reference Documentation
- **Motion**: https://motion.dev (애니메이션 API 및 예제)
- **Phosphor Icons**: https://phosphoricons.com (아이콘 검색 및 사용법)
- **Aceternity UI**: https://ui.aceternity.com (컴포넌트 쇼케이스)
- **Radix Primitives**: https://www.radix-ui.com/primitives (접근성 컴포넌트)

### 2.2 System Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           CLIENT (Browser)                              │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │
│  │  Input Form │  │  Result UI  │  │ Face Camera │  │ Chat Stream │    │
│  │  (Server)   │  │  (Client)   │  │  (Client)   │  │  (Client)   │    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘    │
│         │                │                │                │            │
│         ▼                ▼                ▼                ▼            │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    State Management (Zustand)                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         SERVER (Next.js)                                │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │  Server Actions │  │  API Routes     │  │  Middleware     │         │
│  │  - calculateSaju│  │  - /api/chat    │  │  - Auth check   │         │
│  │  - saveResult   │  │  - /api/face    │  │  - Rate limit   │         │
│  └────────┬────────┘  └────────┬────────┘  └─────────────────┘         │
│           │                    │                                        │
│           ▼                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Library Layer                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │   │
│  │  │lunar-javascript│ │ AI SDK       │  │ Supabase     │           │   │
│  │  │(사주 계산)     │ │ (OpenAI)     │  │ (DB/Auth)    │           │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘           │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                        EXTERNAL SERVICES                                │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │
│  │  OpenAI API │  │  Supabase   │  │   Vercel    │                     │
│  │  (GPT-4o)   │  │  (Postgres) │  │  (Hosting)  │                     │
│  └─────────────┘  └─────────────┘  └─────────────┘                     │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Directory Structure

```
saju-hancom/
├── app/
│   ├── (main)/                      # Route group for main pages
│   │   ├── page.tsx                 # Home: 생년월일 입력 폼
│   │   ├── loading.tsx              # Loading skeleton
│   │   ├── result/
│   │   │   ├── page.tsx             # 사주 결과 + AI 해석
│   │   │   └── loading.tsx
│   │   ├── face-reading/
│   │   │   ├── page.tsx             # 관상 분석
│   │   │   └── loading.tsx
│   │   └── history/
│   │       └── page.tsx             # 분석 기록 (로그인 필요)
│   ├── api/
│   │   ├── chat/
│   │   │   └── route.ts             # AI 스트리밍 엔드포인트
│   │   └── saju/
│   │       └── route.ts             # 사주 계산 API (optional)
│   ├── layout.tsx                   # Root layout
│   ├── globals.css                  # Global styles (Tailwind v4)
│   └── error.tsx                    # Error boundary
│
├── components/
│   ├── ui/                          # shadcn/ui components
│   │   ├── button.tsx
│   │   ├── card.tsx
│   │   ├── input.tsx
│   │   ├── select.tsx
│   │   ├── dialog.tsx
│   │   └── ...
│   ├── saju/
│   │   ├── birth-input-form.tsx     # 생년월일시 입력 폼
│   │   ├── pillar-card.tsx          # 개별 주(柱) 표시 카드
│   │   ├── four-pillars.tsx         # 사주팔자 4주 표시
│   │   ├── element-chart.tsx        # 오행 도넛 차트
│   │   ├── ten-gods-table.tsx       # 십성 분석 테이블
│   │   └── fortune-result.tsx       # 종합 결과 컨테이너
│   ├── face/
│   │   ├── camera-capture.tsx       # 웹캠/사진 캡처
│   │   ├── face-analyzer.tsx        # MediaPipe 분석기
│   │   └── face-result.tsx          # 관상 결과 표시
│   ├── chat/
│   │   ├── fortune-stream.tsx       # AI 스트리밍 채팅
│   │   └── message-bubble.tsx       # 채팅 버블
│   └── layout/
│       ├── header.tsx               # 상단 네비게이션
│       ├── footer.tsx               # 하단 푸터
│       └── mobile-nav.tsx           # 모바일 네비게이션
│
├── lib/
│   ├── saju/
│   │   ├── calculator.ts            # 핵심 사주 계산 로직
│   │   ├── solar-time.ts            # 진태양시 보정
│   │   ├── ten-gods.ts              # 십성 계산
│   │   ├── stars.ts                 # 신살 계산
│   │   ├── elements.ts              # 오행 점수 계산
│   │   ├── constants.ts             # 천간/지지/오행 상수
│   │   └── types.ts                 # TypeScript 타입 정의
│   ├── face/
│   │   ├── analyzer.ts              # 얼굴 분석 로직
│   │   ├── landmarks.ts             # 랜드마크 좌표 처리
│   │   ├── ratios.ts                # 비율 계산
│   │   └── types.ts                 # 관상 관련 타입
│   ├── prompts/
│   │   ├── fortune.ts               # 운세 프롬프트 템플릿
│   │   ├── face-reading.ts          # 관상 프롬프트
│   │   └── combined.ts              # 통합 프롬프트
│   ├── supabase/
│   │   ├── client.ts                # Supabase 클라이언트
│   │   ├── server.ts                # 서버사이드 클라이언트
│   │   └── types.ts                 # Database 타입
│   ├── store/
│   │   └── saju-store.ts            # Zustand 스토어
│   └── utils/
│       ├── cn.ts                    # className 유틸리티
│       └── date.ts                  # 날짜 유틸리티
│
├── public/
│   ├── images/
│   │   ├── elements/                # 오행 아이콘 (목화토금수)
│   │   └── zodiac/                  # 12지지 아이콘
│   └── fonts/                       # 추가 폰트 (필요시)
│
├── .taskmaster/
│   └── docs/
│       └── prd.txt                  # 이 문서
│
├── .env.local                       # 환경 변수 (gitignored)
├── .env.example                     # 환경 변수 템플릿
├── package.json
├── tsconfig.json
├── tailwind.config.ts               # Tailwind v4는 불필요할 수 있음
└── next.config.ts
```

================================================================================
## 3. FEATURE SPECIFICATIONS
================================================================================

### 3.1 Feature: 사주 팔자 산출 (Saju Calculation)

#### 3.1.1 Overview
사용자의 생년월일시를 입력받아 정확한 사주팔자(四柱八字)를 계산합니다.
lunar-javascript 라이브러리를 활용하여 24절기 기준 월주 산출 및
진태양시 보정을 적용합니다.

#### 3.1.2 Input Specification

```typescript
interface SajuInput {
  // 필수 입력
  year: number;           // 출생 연도 (1900-2100)
  month: number;          // 출생 월 (1-12)
  day: number;            // 출생 일 (1-31)
  hour: number;           // 출생 시 (0-23)
  minute: number;         // 출생 분 (0-59)
  gender: 'male' | 'female';

  // 옵션 입력
  isLunar: boolean;       // 음력 여부 (default: false)
  isLeapMonth: boolean;   // 윤달 여부 (isLunar=true일 때만)
  longitude?: number;     // 출생지 경도 (진태양시 보정용, default: 127.5)
}
```

#### 3.1.3 Output Specification

```typescript
// 천간 (Heavenly Stems)
type Gan = '甲' | '乙' | '丙' | '丁' | '戊' | '己' | '庚' | '辛' | '壬' | '癸';

// 지지 (Earthly Branches)
type Zhi = '子' | '丑' | '寅' | '卯' | '辰' | '巳' | '午' | '未' | '申' | '酉' | '戌' | '亥';

// 오행 (Five Elements)
type Element = 'wood' | 'fire' | 'earth' | 'metal' | 'water';

// 십성 (Ten Gods)
type TenGod =
  | 'bijian'    // 비견 (劫財) - Peer
  | 'gebjae'    // 겁재 (劫財) - Rob Wealth
  | 'siksin'    // 식신 (食神) - Eating God
  | 'sanggwan'  // 상관 (傷官) - Hurting Officer
  | 'pyeonjae'  // 편재 (偏財) - Indirect Wealth
  | 'jeongjae'  // 정재 (正財) - Direct Wealth
  | 'pyeongwan' // 편관 (偏官) - Indirect Authority
  | 'jeonggwan' // 정관 (正官) - Direct Authority
  | 'pyeonin'   // 편인 (偏印) - Indirect Seal
  | 'jeongin';  // 정인 (正印) - Direct Seal

interface Pillar {
  gan: Gan;               // 천간
  zhi: Zhi;               // 지지
  ganZhi: string;         // 간지 조합 (예: "甲子")
  ganElement: Element;    // 천간 오행
  zhiElement: Element;    // 지지 오행 (정기)
  zhiHiddenGan: Gan[];    // 지지 장간 (숨은 천간)
}

interface TenGodAnalysis {
  year: { gan: TenGod; zhi: TenGod };
  month: { gan: TenGod; zhi: TenGod };
  day: { gan: TenGod; zhi: TenGod };  // 일간은 본인
  time: { gan: TenGod; zhi: TenGod };
}

interface SajuResult {
  // 사주 팔자
  pillars: {
    year: Pillar;   // 년주 (조상, 어린시절)
    month: Pillar;  // 월주 (부모, 청년기)
    day: Pillar;    // 일주 (본인, 배우자)
    time: Pillar;   // 시주 (자녀, 노년기)
  };

  // 일간 (Day Master) - 본인을 나타내는 핵심
  dayMaster: Gan;
  dayMasterElement: Element;
  dayMasterDescription: string;  // "甲木 (갑목) - 큰 나무"

  // 오행 분포 (0-100 점수)
  elementScores: {
    wood: number;   // 목
    fire: number;   // 화
    earth: number;  // 토
    metal: number;  // 금
    water: number;  // 수
  };

  // 오행 분석
  elementAnalysis: {
    dominant: Element[];     // 가장 강한 오행
    lacking: Element[];      // 부족한 오행
    balance: 'balanced' | 'unbalanced';
  };

  // 십성 분석
  tenGods: TenGodAnalysis;
  tenGodSummary: {
    dominant: TenGod[];      // 많이 나타나는 십성
    lacking: TenGod[];       // 없거나 적은 십성
  };

  // 신살 (Stars/Spirits)
  stars: {
    name: string;            // 예: "천을귀인"
    description: string;     // 설명
    type: 'auspicious' | 'inauspicious';  // 길신/흉살
  }[];

  // 대운 정보 (추후 확장)
  majorFortune?: {
    startAge: number;
    periods: Array<{
      age: [number, number];
      pillar: Pillar;
    }>;
  };

  // 메타 정보
  meta: {
    solarDate: string;       // 양력 "2024-01-15"
    lunarDate: string;       // 음력 "2023-12-05"
    solarTime: string;       // 입력 시간
    trueSolarTime: string;   // 진태양시 보정 후
    jieQi: string;           // 해당 절기
  };
}
```

#### 3.1.4 Core Algorithm: 진태양시 보정

```typescript
/**
 * 진태양시(True Solar Time) 보정
 *
 * 한국 표준시는 동경 135도 기준이지만,
 * 실제 서울은 동경 127.5도에 위치합니다.
 *
 * 시차 = (표준경도 - 실제경도) × 4분/도
 * 서울: (135 - 127.5) × 4 = 30분
 *
 * 따라서 입력 시간에서 약 30분을 빼야 실제 태양 시간입니다.
 */
function adjustToTrueSolarTime(
  date: Date,
  longitude: number = 127.5,  // 서울 기본값
  standardMeridian: number = 135  // 한국 표준시 기준
): Date {
  const offsetMinutes = (standardMeridian - longitude) * 4;
  const adjustedDate = new Date(date);
  adjustedDate.setMinutes(adjustedDate.getMinutes() - offsetMinutes);
  return adjustedDate;
}

// 예시:
// 입력: 1990-01-15 13:00 (서울)
// 진태양시: 1990-01-15 12:30
// 이 시간으로 사주를 계산해야 정확합니다.
```

#### 3.1.5 lunar-javascript 사용 예시

```typescript
import { Solar, Lunar } from 'lunar-javascript';

export function calculateSaju(input: SajuInput): SajuResult {
  // 1. 진태양시 보정
  const inputDate = new Date(
    input.year, input.month - 1, input.day,
    input.hour, input.minute
  );
  const adjustedDate = adjustToTrueSolarTime(inputDate, input.longitude);

  // 2. Solar 객체 생성
  const solar = Solar.fromYmdHms(
    adjustedDate.getFullYear(),
    adjustedDate.getMonth() + 1,
    adjustedDate.getDate(),
    adjustedDate.getHours(),
    adjustedDate.getMinutes(),
    0
  );

  // 3. 음력 변환 (절기 기준 자동 적용)
  const lunar = solar.getLunar();

  // 4. 사주 추출
  const yearGanZhi = lunar.getYearInGanZhi();   // 년주
  const monthGanZhi = lunar.getMonthInGanZhi(); // 월주 (절기 기준)
  const dayGanZhi = lunar.getDayInGanZhi();     // 일주
  const timeGanZhi = lunar.getTimeInGanZhi();   // 시주

  // 5. 일간 추출
  const dayGan = lunar.getDayGan();  // 예: "甲"

  // 6. 오행 점수 계산
  const elementScores = calculateElementScores([
    yearGanZhi, monthGanZhi, dayGanZhi, timeGanZhi
  ]);

  // 7. 십성 계산
  const tenGods = calculateTenGods(dayGan, {
    year: yearGanZhi,
    month: monthGanZhi,
    day: dayGanZhi,
    time: timeGanZhi
  });

  // 8. 신살 계산
  const stars = calculateStars(lunar);

  return {
    pillars: { /* ... */ },
    dayMaster: dayGan,
    // ... 나머지 결과
  };
}
```

---

### 3.2 Feature: 반응형 UI/UX (Mobile First)

#### 3.2.1 Design Principles

1. **Mobile First**: 모든 디자인은 모바일(375px)에서 시작
2. **Touch Friendly**: 버튼/터치 영역 최소 44px
3. **Fast Feedback**: 모든 액션에 즉각적 피드백
4. **Progressive Disclosure**: 정보를 단계적으로 노출

#### 3.2.2 Responsive Breakpoints

```css
/* Tailwind v4 breakpoints */
sm: 640px    /* 태블릿 세로 */
md: 768px    /* 태블릿 가로 */
lg: 1024px   /* 데스크탑 */
xl: 1280px   /* 대형 모니터 */
```

#### 3.2.3 Layout Structure

```tsx
// app/(main)/layout.tsx
export default function MainLayout({ children }) {
  return (
    <div className="min-h-dvh bg-gradient-to-b from-slate-900 to-slate-800">
      <Header />
      <main className="max-w-md mx-auto px-4 pb-20">
        {children}
      </main>
      <MobileNav />  {/* 하단 고정 네비게이션 */}
    </div>
  );
}
```

#### 3.2.4 Color Scheme

```css
/* 음양오행 기반 색상 체계 */
:root {
  /* 오행 색상 */
  --element-wood: #22c55e;   /* 초록 - 목 */
  --element-fire: #ef4444;   /* 빨강 - 화 */
  --element-earth: #eab308;  /* 노랑 - 토 */
  --element-metal: #f8fafc;  /* 흰색 - 금 */
  --element-water: #3b82f6;  /* 파랑 - 수 */

  /* 음양 */
  --yin: #6366f1;            /* 음 - 차가운 보라 */
  --yang: #f97316;           /* 양 - 따뜻한 주황 */

  /* 배경 */
  --bg-primary: #0f172a;     /* slate-900 */
  --bg-secondary: #1e293b;   /* slate-800 */
  --bg-card: #334155;        /* slate-700 */

  /* 텍스트 */
  --text-primary: #f8fafc;   /* slate-50 */
  --text-secondary: #94a3b8; /* slate-400 */
}
```

#### 3.2.5 Key UI Components

**A. 생년월일 입력 폼 (BirthInputForm)**

```tsx
interface BirthInputFormProps {
  onSubmit: (data: SajuInput) => void;
  isLoading: boolean;
}

// 구성 요소:
// - 연도 선택 (1900-2100, 휠/드롭다운)
// - 월 선택 (1-12)
// - 일 선택 (1-31, 월에 따라 동적)
// - 시간 선택 (0-23시)
// - 분 선택 (0-59분)
// - 음/양력 토글 스위치
// - 성별 라디오 버튼
// - "운세 보기" 제출 버튼
```

**B. 사주 팔자 표시 (FourPillars)**

```tsx
// 4개의 수직 카드로 구성
// 각 카드에 천간(위), 지지(아래) 표시
// 오행에 따른 배경색 적용
// 한자 + 한글 발음 + 의미 표시

// 시각적 구조:
// ┌────┐ ┌────┐ ┌────┐ ┌────┐
// │ 甲 │ │ 丙 │ │ 庚 │ │ 壬 │  ← 천간
// │ 子 │ │ 寅 │ │ 午 │ │ 戌 │  ← 지지
// │년주│ │월주│ │일주│ │시주│
// └────┘ └────┘ └────┘ └────┘
```

**C. 오행 차트 (ElementChart)**

```tsx
// Recharts PieChart 사용
// 도넛 형태로 오행 분포 시각화
// 중앙에 가장 강한 오행 아이콘 표시
// 범례는 차트 아래에 배치

import { PieChart, Pie, Cell, Legend } from 'recharts';

const ELEMENT_COLORS = {
  wood: '#22c55e',
  fire: '#ef4444',
  earth: '#eab308',
  metal: '#f8fafc',
  water: '#3b82f6',
};
```

---

### 3.3 Feature: AI 관상 분석 (Face Reading)

#### 3.3.1 Overview
MediaPipe Face Mesh를 사용하여 클라이언트에서 얼굴 468개 랜드마크를 추출하고,
기하학적 비율을 계산하여 관상학적 특징을 분석합니다.

#### 3.3.2 Face Landmark Analysis

```typescript
interface FaceMeasurements {
  // 삼정(三停) - 얼굴 3등분 비율
  threeZones: {
    upper: number;    // 이마 (헤어라인 ~ 눈썹)
    middle: number;   // 중안부 (눈썹 ~ 코끝)
    lower: number;    // 하관 (코끝 ~ 턱끝)
    ratio: string;    // "1:1:1" 형태
    analysis: string; // "상정이 발달하여 지적 능력이 뛰어남"
  };

  // 눈 분석
  eyes: {
    lengthRatio: number;      // 눈 길이 / 얼굴 너비
    tilt: number;             // 눈꼬리 각도 (양수: 올라감)
    distance: number;         // 눈 사이 거리 / 눈 길이
    analysis: string;
  };

  // 코 분석
  nose: {
    length: number;           // 코 길이 / 얼굴 높이
    width: number;            // 콧볼 너비 / 얼굴 너비
    bridgeHeight: string;     // 'high' | 'medium' | 'low'
    analysis: string;
  };

  // 입술 분석
  lips: {
    width: number;            // 입 너비 / 얼굴 너비
    thickness: string;        // 'thin' | 'medium' | 'thick'
    cupidBow: boolean;        // 윗입술 M자 형태
    analysis: string;
  };

  // 얼굴형
  faceShape: {
    type: 'oval' | 'round' | 'square' | 'heart' | 'long';
    jawWidth: number;         // 하관 너비 / 광대 너비
    foreheadWidth: number;    // 이마 너비 / 광대 너비
    analysis: string;
  };

  // 황금비율 점수 (0-100)
  goldenRatioScore: number;
}
```

#### 3.3.3 Key Landmark Indices (MediaPipe)

```typescript
const LANDMARK_INDICES = {
  // 얼굴 윤곽
  faceContour: [10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288,
                397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136,
                172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109],

  // 눈 (왼쪽)
  leftEye: {
    inner: 133,
    outer: 33,
    top: 159,
    bottom: 145,
  },

  // 눈 (오른쪽)
  rightEye: {
    inner: 362,
    outer: 263,
    top: 386,
    bottom: 374,
  },

  // 코
  nose: {
    tip: 4,
    bridge: 6,
    leftNostril: 129,
    rightNostril: 358,
  },

  // 입술
  lips: {
    upperTop: 0,
    upperBottom: 13,
    lowerTop: 14,
    lowerBottom: 17,
    leftCorner: 61,
    rightCorner: 291,
  },

  // 이마/턱
  forehead: 10,
  chin: 152,
  leftJaw: 234,
  rightJaw: 454,
  leftCheek: 93,
  rightCheek: 323,
};
```

#### 3.3.4 Analysis Flow

```
1. 카메라/이미지 입력
   └── react-webcam 또는 <input type="file" accept="image/*" capture="user">

2. MediaPipe 초기화
   └── @mediapipe/face_mesh 로드 (dynamic import로 번들 최적화)

3. 랜드마크 추출
   └── 468개 3D 좌표 (x, y, z)

4. 비율 계산
   └── 유클리드 거리 공식으로 각 부위 측정

5. 분석 결과 생성
   └── FaceMeasurements 객체 생성

6. 텍스트 변환
   └── LLM 프롬프트용 자연어 설명 생성

7. AI 해석 요청
   └── 사주 데이터와 결합하여 종합 운세 생성
```

---

### 3.4 Feature: LLM 운세 생성 (AI Fortune Streaming)

#### 3.4.1 Vercel AI SDK Integration

```typescript
// app/api/chat/route.ts
import { openai } from '@ai-sdk/openai';
import { streamText } from 'ai';

export async function POST(req: Request) {
  const { sajuData, faceData, category } = await req.json();

  const systemPrompt = buildSystemPrompt();
  const userPrompt = buildUserPrompt(sajuData, faceData, category);

  const result = await streamText({
    model: openai('gpt-4o'),
    system: systemPrompt,
    messages: [{ role: 'user', content: userPrompt }],
    temperature: 0.7,
    maxTokens: 2000,
  });

  return result.toDataStreamResponse();
}
```

#### 3.4.2 Prompt Engineering

```typescript
// lib/prompts/fortune.ts

export function buildSystemPrompt(): string {
  return `
당신은 30년 경력의 동양 명리학 전문가입니다.
사주팔자와 관상학에 정통하며, 복잡한 개념을 일반인도 이해할 수 있게 설명합니다.

[답변 원칙]
1. 전문 용어는 반드시 괄호 안에 한글 풀이를 함께 제공
   예: "편관(偏官, 권력과 도전을 상징)"

2. 긍정적인 면을 먼저 언급하고, 주의점은 조언 형태로

3. 구체적인 행동 가이드 제시
   예: "올해 상반기는 새로운 시작에 유리합니다. 특히 3월과 7월에..."

4. 미신적 표현 지양, 심리학적/통계적 관점에서 해석

5. 사용자의 선택과 노력이 중요함을 강조

[포맷]
- 이모지를 적절히 활용하여 가독성 향상
- 핵심 키워드는 **볼드** 처리
- 단락 구분을 명확히
`;
}

export function buildUserPrompt(
  saju: SajuResult,
  face?: FaceMeasurements,
  category?: 'general' | 'love' | 'career' | 'wealth' | 'health'
): string {
  let prompt = `
[사주 정보]
- 일간(본인): ${saju.dayMaster} (${saju.dayMasterDescription})
- 사주팔자:
  년주: ${saju.pillars.year.ganZhi}
  월주: ${saju.pillars.month.ganZhi}
  일주: ${saju.pillars.day.ganZhi}
  시주: ${saju.pillars.time.ganZhi}

- 오행 분포:
  목(木): ${saju.elementScores.wood}점
  화(火): ${saju.elementScores.fire}점
  토(土): ${saju.elementScores.earth}점
  금(金): ${saju.elementScores.metal}점
  수(水): ${saju.elementScores.water}점

- 주요 십성: ${saju.tenGodSummary.dominant.join(', ')}
- 주요 신살: ${saju.stars.map(s => s.name).join(', ')}
`;

  if (face) {
    prompt += `
[관상 정보]
- 삼정 비율: ${face.threeZones.ratio}
- 눈: ${face.eyes.analysis}
- 얼굴형: ${face.faceShape.type}
- 특이사항: ${face.lips.analysis}
`;
  }

  const categoryGuide = {
    general: '전체적인 운세와 성격, 올해의 흐름을 종합적으로 분석해주세요.',
    love: '연애운과 대인관계, 궁합 포인트를 중심으로 분석해주세요.',
    career: '직업운, 적성, 승진/이직 시기를 중심으로 분석해주세요.',
    wealth: '재물운, 투자 적기, 금전 관리 조언을 중심으로 분석해주세요.',
    health: '건강운과 주의해야 할 신체 부위를 중심으로 분석해주세요.',
  };

  prompt += `\n[요청]\n${categoryGuide[category || 'general']}`;

  return prompt;
}
```

#### 3.4.3 Client-Side Streaming

```tsx
// components/chat/fortune-stream.tsx
'use client';

import { useChat } from 'ai/react';

export function FortuneStream({ sajuData, faceData }: Props) {
  const { messages, isLoading, error } = useChat({
    api: '/api/chat',
    body: { sajuData, faceData, category: 'general' },
    initialMessages: [],
  });

  return (
    <div className="space-y-4">
      {isLoading && <TypingIndicator />}

      {messages.map((message) => (
        <MessageBubble
          key={message.id}
          role={message.role}
          content={message.content}
        />
      ))}

      {error && <ErrorMessage error={error} />}
    </div>
  );
}
```

================================================================================
## 4. DATA MODELS & DATABASE
================================================================================

### 4.1 Supabase Schema

```sql
-- 사용자 테이블 (Supabase Auth와 연동)
CREATE TABLE profiles (
  id UUID REFERENCES auth.users PRIMARY KEY,
  nickname TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 사주 분석 기록
CREATE TABLE saju_readings (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES profiles(id),

  -- 입력 데이터
  birth_year INT NOT NULL,
  birth_month INT NOT NULL,
  birth_day INT NOT NULL,
  birth_hour INT NOT NULL,
  birth_minute INT NOT NULL,
  is_lunar BOOLEAN DEFAULT FALSE,
  gender TEXT NOT NULL CHECK (gender IN ('male', 'female')),
  longitude DECIMAL(9,6) DEFAULT 127.5,

  -- 계산 결과
  saju_result JSONB NOT NULL,  -- SajuResult 전체 저장

  -- AI 해석
  ai_interpretation TEXT,

  -- 메타
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 관상 분석 기록
CREATE TABLE face_readings (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES profiles(id),
  saju_reading_id UUID REFERENCES saju_readings(id),

  -- 분석 결과
  face_measurements JSONB NOT NULL,  -- FaceMeasurements 저장
  ai_interpretation TEXT,

  -- 이미지 (선택적)
  image_url TEXT,  -- Supabase Storage URL

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Row Level Security (RLS)
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE saju_readings ENABLE ROW LEVEL SECURITY;
ALTER TABLE face_readings ENABLE ROW LEVEL SECURITY;

-- 정책: 본인 데이터만 접근 가능
CREATE POLICY "Users can view own profile" ON profiles
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can view own readings" ON saju_readings
  FOR SELECT USING (auth.uid() = user_id);
```

### 4.2 Environment Variables

```bash
# .env.local (gitignored)

# OpenAI
OPENAI_API_KEY=sk-...

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
SUPABASE_SERVICE_ROLE_KEY=eyJ...  # 서버 전용

# Optional: Analytics
NEXT_PUBLIC_GA_ID=G-XXXXXXX
```

================================================================================
## 5. IMPLEMENTATION ROADMAP
================================================================================

### Phase 1: Project Setup (Priority: P0)
**Estimated Tasks: 6**

1.1. 의존성 설치
   - lunar-javascript, ai, @ai-sdk/openai 설치
   - zustand, recharts, lucide-react 설치
   - shadcn/ui CLI 실행 및 기본 컴포넌트 추가

1.2. 디렉토리 구조 생성
   - lib/, components/ 하위 폴더 구조 생성
   - 타입 정의 파일 생성 (lib/saju/types.ts, lib/face/types.ts)

1.3. 환경 설정
   - .env.example 생성
   - Tailwind 테마 확장 (오행 색상)

1.4. 기본 레이아웃 구성
   - app/(main)/layout.tsx 작성
   - Header, MobileNav 컴포넌트 생성

---

### Phase 2: Saju Logic Implementation (Priority: P0)
**Estimated Tasks: 10**

2.1. 상수 정의 (lib/saju/constants.ts)
   - 천간 10개, 지지 12개 정의
   - 오행 매핑 테이블
   - 십성 관계 테이블
   - 신살 조건 테이블

2.2. 타입 정의 (lib/saju/types.ts)
   - SajuInput, SajuResult 인터페이스
   - Pillar, TenGod, Element 타입

2.3. 진태양시 보정 (lib/saju/solar-time.ts)
   - adjustToTrueSolarTime() 함수 구현
   - 경도별 오프셋 계산 로직

2.4. 핵심 계산기 (lib/saju/calculator.ts)
   - calculateSaju() 메인 함수
   - lunar-javascript 연동
   - 팔자 추출 로직

2.5. 오행 점수 계산 (lib/saju/elements.ts)
   - calculateElementScores() 함수
   - 천간/지지 장간의 오행 가중치 계산

2.6. 십성 계산 (lib/saju/ten-gods.ts)
   - calculateTenGods() 함수
   - 일간 기준 관계 판정

2.7. 신살 계산 (lib/saju/stars.ts)
   - calculateStars() 함수
   - 천을귀인, 도화살 등 주요 신살

2.8. 테스트 케이스 작성
   - 알려진 사주 데이터로 검증
   - 만세력 사이트 결과와 비교

---

### Phase 3: UI Construction (Priority: P1)
**Estimated Tasks: 12**

3.1. shadcn/ui 컴포넌트 설치
   - Button, Card, Input, Select, Dialog, Tabs
   - Switch, RadioGroup, DatePicker (custom)

3.2. 생년월일 입력 폼 (components/saju/birth-input-form.tsx)
   - 연/월/일/시/분 선택기
   - 음양력 토글
   - 성별 선택
   - 폼 검증 (zod + react-hook-form)

3.3. 사주 표시 컴포넌트
   - pillar-card.tsx: 개별 주 카드
   - four-pillars.tsx: 4주 그리드 배치

3.4. 오행 차트 (components/saju/element-chart.tsx)
   - Recharts PieChart 도넛 차트
   - 범례 및 툴팁

3.5. 십성 테이블 (components/saju/ten-gods-table.tsx)
   - 그리드 형태 십성 분포 표시

3.6. 결과 페이지 (app/(main)/result/page.tsx)
   - 4주 표시 + 차트 + 십성 + AI 해석 통합

3.7. 로딩 상태 UI
   - Skeleton 컴포넌트
   - 애니메이션 효과

3.8. 에러 처리 UI
   - Error boundary
   - Toast 알림

---

### Phase 4: LLM Integration (Priority: P2)
**Estimated Tasks: 6**

4.1. API Route 구현 (app/api/chat/route.ts)
   - OpenAI 연동
   - 스트리밍 설정

4.2. 프롬프트 템플릿 작성 (lib/prompts/)
   - 시스템 프롬프트
   - 카테고리별 사용자 프롬프트

4.3. 스트리밍 UI (components/chat/fortune-stream.tsx)
   - useChat 훅 사용
   - 타이핑 인디케이터

4.4. 메시지 버블 (components/chat/message-bubble.tsx)
   - Markdown 렌더링
   - 스타일링

4.5. 카테고리 선택 UI
   - 운세 종류 탭/버튼
   - 재물운, 연애운, 건강운 등

4.6. 에러 핸들링
   - API 오류 처리
   - 재시도 로직

---

### Phase 5: Face Reading Feature (Priority: P3)
**Estimated Tasks: 8**

5.1. MediaPipe 설정
   - Dynamic import로 번들 최적화
   - 초기화 로직

5.2. 카메라 캡처 (components/face/camera-capture.tsx)
   - react-webcam 또는 file input
   - 캡처/업로드 버튼

5.3. 랜드마크 추출 (lib/face/landmarks.ts)
   - 468포인트 좌표 추출
   - 주요 인덱스 상수 정의

5.4. 비율 계산 (lib/face/ratios.ts)
   - 삼정 비율
   - 눈/코/입 측정

5.5. 분석 결과 생성 (lib/face/analyzer.ts)
   - FaceMeasurements 객체 생성
   - 텍스트 설명 생성

5.6. 결과 표시 UI (components/face/face-result.tsx)
   - 측정 결과 시각화
   - 오버레이 표시 (선택적)

5.7. 관상 프롬프트 (lib/prompts/face-reading.ts)
   - 관상 전용 프롬프트

5.8. 관상 페이지 (app/(main)/face-reading/page.tsx)
   - 전체 플로우 통합

---

### Phase 6: Optimization & Polish (Priority: P4)
**Estimated Tasks: 6**

6.1. SEO 최적화
   - Metadata API 사용
   - Open Graph 이미지

6.2. 성능 최적화
   - Image optimization
   - Code splitting
   - Lazy loading

6.3. 접근성 개선
   - ARIA labels
   - 키보드 네비게이션

6.4. PWA 설정 (선택)
   - manifest.json
   - Service worker

6.5. 에러 모니터링
   - Error boundary
   - 로깅 설정

6.6. Analytics 설정
   - Google Analytics 또는 Vercel Analytics

================================================================================
## 6. TECHNICAL CONSTRAINTS & RISKS
================================================================================

### 6.1 Known Limitations

| 항목 | 제한사항 | 대응 방안 |
|------|---------|----------|
| lunar-javascript | 일부 고급 신살 미지원 | 자체 로직 추가 구현 |
| MediaPipe | 브라우저 호환성 | Chrome/Safari 우선 지원 |
| OpenAI API | 토큰 비용 | 캐싱, 응답 길이 제한 |
| 진태양시 | 정확도 한계 | 경도 입력 옵션 제공 |

### 6.2 Risk Mitigation

1. **사주 계산 정확도**
   - 만세력 사이트 결과와 교차 검증
   - 유명인 사주로 테스트 케이스 작성

2. **MediaPipe 번들 크기 (~3MB)**
   - Dynamic import 사용
   - 관상 페이지 진입 시에만 로드

3. **LLM 응답 품질**
   - 프롬프트 A/B 테스트
   - 사용자 피드백 수집

4. **모바일 성능**
   - Chrome DevTools Lighthouse 점검
   - 실기기 테스트 (저사양 포함)

================================================================================
## 7. SUCCESS METRICS
================================================================================

### 7.1 Technical KPIs

| 지표 | 목표 | 측정 방법 |
|------|-----|----------|
| First Contentful Paint | < 1.5s | Lighthouse |
| Time to Interactive | < 3.0s | Lighthouse |
| Lighthouse Performance | > 90 | Lighthouse |
| API Response Time | < 2s | Vercel Analytics |
| Error Rate | < 1% | Error Tracking |

### 7.2 Product KPIs (추후)

| 지표 | 목표 | 측정 방법 |
|------|-----|----------|
| 일일 활성 사용자 | 1,000+ | Analytics |
| 세션 완료율 | > 70% | Analytics |
| 재방문율 | > 30% | Analytics |
| AI 해석 만족도 | > 4.0/5 | 피드백 수집 |

================================================================================
## 8. APPENDIX
================================================================================

### 8.1 Glossary

| 용어 | 영문 | 설명 |
|------|-----|------|
| 사주 | Four Pillars | 년월일시의 간지 조합 |
| 팔자 | Eight Characters | 4주 × 2글자(간지) = 8글자 |
| 천간 | Heavenly Stems | 10개 (甲乙丙丁戊己庚辛壬癸) |
| 지지 | Earthly Branches | 12개 (子丑寅卯辰巳午未申酉戌亥) |
| 일간 | Day Master | 일주의 천간, 본인을 상징 |
| 오행 | Five Elements | 목화토금수 |
| 십성 | Ten Gods | 일간 기준 다른 간지와의 관계 |
| 신살 | Stars | 특정 조합에서 나타나는 특수 운 |
| 절기 | Solar Terms | 24절기, 월주 결정 기준 |
| 진태양시 | True Solar Time | 경도 보정된 실제 태양 시간 |

### 8.2 Reference Links

- lunar-javascript: https://github.com/6tail/lunar-javascript
- Vercel AI SDK: https://sdk.vercel.ai/docs
- MediaPipe Face Mesh: https://google.github.io/mediapipe/solutions/face_mesh
- shadcn/ui: https://ui.shadcn.com
- Recharts: https://recharts.org

### 8.3 Related Documents

- 만세력 계산 알고리즘 상세 (별도 문서)
- 관상학 비율 기준표 (별도 문서)
- LLM 프롬프트 버전 이력 (별도 문서)

================================================================================
END OF DOCUMENT
================================================================================
