name: Production Deployment

on:
  push:
    branches: [main]

jobs:
  # Run CI checks first
  ci:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  # Production deployment checklist
  production-check:
    name: Production Readiness
    runs-on: ubuntu-latest
    needs: ci

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify required secrets
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          STRIPE_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          AI_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
        run: |
          echo "ðŸ” Verifying required secrets..."

          missing_secrets=""

          if [ -z "$SUPABASE_URL" ]; then
            missing_secrets="$missing_secrets NEXT_PUBLIC_SUPABASE_URL"
          fi

          if [ -z "$SUPABASE_KEY" ]; then
            missing_secrets="$missing_secrets NEXT_PUBLIC_SUPABASE_ANON_KEY"
          fi

          if [ -z "$STRIPE_KEY" ]; then
            missing_secrets="$missing_secrets STRIPE_SECRET_KEY"
          fi

          if [ -z "$AI_KEY" ]; then
            missing_secrets="$missing_secrets GOOGLE_GENERATIVE_AI_API_KEY"
          fi

          if [ -n "$missing_secrets" ]; then
            echo "âŒ Missing required secrets:$missing_secrets"
            exit 1
          fi

          echo "âœ… All required secrets are configured"

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Lint" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Type Check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Secrets Verified" >> $GITHUB_STEP_SUMMARY

  # Notify on success (optional - integrate with Slack/Discord)
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: production-check
    if: success()

    steps:
      - name: Deployment notification
        run: |
          echo "âœ… Production deployment pipeline completed successfully!"
          echo "Vercel will handle the actual deployment."
