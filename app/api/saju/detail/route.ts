import { NextRequest, NextResponse } from "next/server";
import { google } from "@ai-sdk/google";
import { generateText } from "ai";

/**
 * 사주 상세 분석 API
 * 특정 영역에 대해 더 깊은 분석을 제공
 */

type DetailCategory =
  | "dayMaster"      // 일간 상세
  | "tenGods"        // 십성 상세
  | "stars"          // 신살 상세
  | "fortune"        // 운세 상세
  | "career"         // 직업운 상세
  | "relationship"   // 대인관계 상세
  | "health"         // 건강운 상세
  | "wealth";        // 재물운 상세

const DETAIL_PROMPTS: Record<DetailCategory, string> = {
  dayMaster: `일간(日干)에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **일간의 본질**: 이 일간이 가진 근본적인 성격과 에너지
2. **계절과의 관계**: 태어난 월(월령)이 일간에 미치는 영향
3. **신강/신약 상세**: 왜 신강 또는 신약인지 구체적인 이유
4. **통근과 투출**: 지지에 뿌리를 내린 정도와 천간에 드러난 기운
5. **일간의 장단점**: 이 일간이 가진 구체적인 강점과 약점
6. **일간별 처세술**: 이 일간에게 맞는 삶의 방식과 조언
7. **유명인 사례**: 같은 일간을 가진 유명인과 그들의 특징 (있다면)

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,

  tenGods: `십성(十星) 구조에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **격국 상세 분석**: 이 사주의 격국이 무엇이고 왜 그런지
2. **십성 배치의 의미**: 각 십성이 어느 위치(년월일시)에 있는지와 그 의미
3. **십성 간의 상호작용**: 십성들이 서로 어떻게 영향을 주고받는지
4. **주요 십성의 영향력**: 가장 강한 십성이 인생에 미치는 영향
5. **부족한 십성의 보완**: 없거나 약한 십성을 어떻게 보완할 수 있는지
6. **십성으로 본 인생 패턴**: 십성 구조가 보여주는 인생의 흐름
7. **십성 활용법**: 자신의 십성 구조를 어떻게 활용하면 좋을지

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,

  stars: `신살(神煞)에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **각 신살의 유래**: 이 신살들이 어떻게 해서 생겼는지 역사적 배경
2. **길신 활용법**: 길신(좋은 신살)을 최대한 활용하는 구체적 방법
3. **흉신 해소법**: 흉신(나쁜 신살)의 부정적 영향을 줄이는 방법
4. **신살 간 상호작용**: 여러 신살이 함께 있을 때의 복합 작용
5. **현대적 해석**: 전통적 신살 해석을 현대 생활에 맞게 재해석
6. **주의해야 할 시기**: 특정 신살이 더 강하게 작용하는 시기
7. **신살과 직업**: 신살이 암시하는 적합한 직업이나 활동

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,

  fortune: `대운과 세운에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **대운의 흐름**: 지금까지의 대운과 앞으로의 대운 전체 흐름
2. **현재 대운 상세**: 현재 대운이 원국과 어떻게 작용하는지
3. **올해 세운 상세**: 올해의 천간지지가 사주에 미치는 구체적 영향
4. **합충형파해**: 대운/세운과 원국 사이의 합, 충, 형, 파, 해 관계
5. **중요한 시기**: 특히 주목해야 할 년도나 대운 시기
6. **월운 포인트**: 올해 각 월별로 주의할 점과 기회
7. **장기 전망**: 향후 10-20년의 큰 운세 흐름

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,

  career: `직업운과 사업운에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **적성 분석**: 사주가 보여주는 천직(天職)과 적성
2. **구체적 직업 추천**: 구체적인 직업명과 그 이유
3. **직장생활 스타일**: 조직에서의 업무 스타일과 대인관계
4. **리더십/팔로워십**: 리더로서의 자질과 팀원으로서의 역할
5. **사업 적합도**: 사업을 한다면 어떤 업종이 좋은지
6. **직업운 시기**: 직업적으로 좋은 시기와 주의할 시기
7. **성공 전략**: 사주에 맞는 커리어 성공 전략

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,

  relationship: `대인관계와 연애운에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **연애 스타일 상세**: 어떤 방식으로 사랑하고 사랑받기를 원하는지
2. **이상형 분석**: 사주가 보여주는 이상적인 배우자 유형
3. **배우자 시기**: 인연이 들어오기 좋은 시기
4. **결혼 후 관계**: 결혼 생활에서의 역할과 패턴
5. **대인관계 패턴**: 친구, 동료와의 관계에서 보이는 특징
6. **가족 관계**: 부모, 형제, 자녀와의 관계
7. **관계 개선 조언**: 더 좋은 관계를 위한 구체적 조언

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,

  health: `건강운에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **오행과 장기**: 오행 불균형이 영향을 미치는 장기(臟器)
2. **체질 분석**: 사주가 보여주는 체질적 특성
3. **주의할 질환**: 선천적으로 주의해야 할 질환이나 부위
4. **건강 관리 시기**: 건강에 특히 주의해야 할 시기
5. **오행 보충법**: 부족한 오행을 보충하는 음식, 색상, 방향 등
6. **운동 추천**: 사주에 맞는 운동이나 건강 관리법
7. **정신 건강**: 스트레스 관리와 정신 건강 조언

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,

  wealth: `재물운에 대해 더 깊이 분석해주세요.

다음 내용을 상세히 설명해주세요:
1. **재물 패턴**: 정재(고정수입)형인지 편재(투자/사업)형인지
2. **재물 획득 방법**: 어떤 방식으로 돈을 벌기 좋은지
3. **투자 스타일**: 투자에 대한 성향과 주의점
4. **소비 패턴**: 돈을 쓰는 방식과 개선점
5. **재물운 시기**: 재물이 들어오기 좋은 시기와 주의 시기
6. **부의 축적**: 장기적으로 부를 쌓는 방법
7. **재물과 행운**: 재물운을 높이는 풍수적 조언

전문 명리학 용어를 사용하되, 일반인도 이해할 수 있도록 쉽게 풀어서 설명해주세요.`,
};

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { category, sajuContext, gender } = body;

    if (!category || !sajuContext) {
      return NextResponse.json(
        { error: "카테고리와 사주 컨텍스트가 필요합니다." },
        { status: 400 }
      );
    }

    if (!DETAIL_PROMPTS[category as DetailCategory]) {
      return NextResponse.json(
        { error: "유효하지 않은 카테고리입니다." },
        { status: 400 }
      );
    }

    const genderText = gender === "female" ? "여성" : "남성";
    const currentYear = new Date().getFullYear();

    const result = await generateText({
      model: google("gemini-2.0-flash"),
      messages: [
        {
          role: "system",
          content: `당신은 수십 년 경력의 전문 역술가입니다.
전통 명리학(사주팔자)에 정통하며, 깊이 있는 분석과 실용적인 조언을 제공합니다.
현재 연도는 ${currentYear}년입니다.

분석할 때 다음을 지켜주세요:
- 전문적이면서도 이해하기 쉽게 설명
- 구체적인 예시와 함께 설명
- 긍정적인 면과 주의점을 균형있게 제시
- 실생활에 적용할 수 있는 조언 포함
- 마크다운 형식으로 구조화하여 작성`,
        },
        {
          role: "user",
          content: `다음은 ${genderText}의 사주 정보입니다:

${sajuContext}

${DETAIL_PROMPTS[category as DetailCategory]}`,
        },
      ],
    });

    return NextResponse.json({
      content: result.text,
      category
    });
  } catch (error) {
    console.error("Saju detail analysis error:", error);
    return NextResponse.json(
      { error: "상세 분석 중 오류가 발생했습니다." },
      { status: 500 }
    );
  }
}
